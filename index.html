<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyrics Library</title>
    <style>
        :root {
            --bg-color: #f9f9fa;
            --text-color: #333;
            --primary: #0066cc;
            --border: #ccc;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: all 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        body.searched {
            justify-content: flex-start;
        }
        .search-container {
            text-align: center;
            width: 100%;
            max-width: 600px;
            transition: all 0.3s ease;
        }
        .search-box {
            width: 100%;
            padding: 12px 20px;
            font-size: 18px;
            border: 2px solid var(--border);
            border-radius: 25px;
            outline: none;
            box-sizing: border-box;
        }
        .search-box:focus {
            border-color: var(--primary);
        }
        .options {
            margin-top: 15px;
            font-size: 14px;
        }
        #results-header {
            display: none;
            margin-top: 30px;
            font-size: 20px;
            font-weight: bold;
            width: 100%;
            max-width: 800px;
            text-align: left;
        }
        #results {
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .result-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .result-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .tabs {
            margin-bottom: 10px;
        }
        .tabs button {
            background: none;
            border: 1px solid var(--border);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 5px;
        }
        .tabs button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .content-display {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }
        .actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .action-btn {
            background: #e0e0e0;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }
        .action-btn:hover {
            background: #d0d0d0;
        }
        .loading {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="search-container" id="search-container">
            	</p>
<a href="contribute.html">MusixMatch Contribution</a>
    </p>
        
        <input type="text" id="search-input" class="search-box" placeholder="Search lyrics..." autocomplete="off">
        <div class="options">
            <label>
                <input type="checkbox" id="search-files-check" checked> Look within .lrc files content
            </label>
        </div>
    </div>

    <div class="loading" id="loading">Searching...</div>
    <div id="results-header"></div>
    <div id="results"></div>

    <script>
        const searchInput = document.getElementById('search-input');
        const searchFilesCheck = document.getElementById('search-files-check');
        const resultsHeader = document.getElementById('results-header');
        const resultsContainer = document.getElementById('results');
        const loading = document.getElementById('loading');

        let fileList = [];
        let fileContentsCache = {};

        // Load data.txt on startup
        async function loadFileList() {
            try {
                const response = await fetch('data.txt');
                if (!response.ok) throw new Error("data.txt not found");
                const text = await response.text();
                fileList = text.split('\n').map(f => f.trim()).filter(f => f.length > 0);
            } catch (e) {
                console.error("Error loading data.txt:", e);
                resultsContainer.innerHTML = "<p>Error: Could not load data.txt. Ensure it exists in the same directory.</p>";
            }
        }

        async function fetchFileContent(filename) {
            if (fileContentsCache[filename]) return fileContentsCache[filename];
            try {
                const response = await fetch(`lyrics/${filename}`);
                if (!response.ok) return "";
                const text = await response.text();
                fileContentsCache[filename] = text;
                return text;
            } catch {
                return "";
            }
        }

        function stripLrcTags(text) {
                function stripLrcTags(text) {
            if (!text) return "";
            return text.split(/\r?\n/)
                // Only keep lines that start with a bracketed tag [ ]
                .filter(line => /^\[.+?\]/.test(line.trim())) 
                // Remove all tags from those lines, leaving just the text
                .map(line => line.replace(/\[.*?\]/g, '').trim()) 
                // Remove any lines that are empty after stripping the tags
                .filter(line => line.length > 0) 
                .join('\n'); 
        }


        function normalizeText(str) {
            if (!str) return "";
            return str
                            // New word-start normalizations (must run before spaces are removed)
                .replace(/(^|\s)ⵜ[ⴰⵓⵉ]/g, '$1ⵜ') // ⵜⴰ, ⵜⵓ, ⵜⵉ to ⵜ
                .replace(/(^|\s)[ⴰⵓⵉ]/g, '$1ⴰ')   // ⴰ, ⵓ, ⵉ to ⴰ
                .replace(/(^|\s)ⵡⵓ/g, '$1ⵓ')      // ⵡⵓ to ⵓ
                .replace(/(^|\s)ⵢⵉ/g, '$1ⵉ')      // ⵢⵉ to ⵉ
                
           
                .replace(/ⵕ/g, 'ⵔ')
                .replace(/ⵯ/g, '')
                .replace(/ⵚ/g, 'ⵙ')
                .replace(/ⵥ/g, 'ⵣ')
                .replace(/ⴹ/g, 'ⴷ')
                .replace(/ⵟ/g, 'ⵜ')
                .replace(/\s+/g, '') // Remove spaces
                .replace(/(.)\1+/g, '$1'); // Remove gemination (double letters to single)
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        async function performSearch(query) {
            if (!query.trim()) {
                document.body.classList.remove('searched');
                resultsHeader.style.display = 'none';
                resultsContainer.innerHTML = '';
                return;
            }

            document.body.classList.add('searched');
            resultsHeader.style.display = 'block';
            resultsHeader.textContent = `Results of "${query}"`;
            resultsContainer.innerHTML = '';
            loading.style.display = 'block';

            const searchInFiles = searchFilesCheck.checked;
            let results = [];
            const queryClean = query.trim();
            const words = queryClean.split(/\s+/);
            const normQuery = normalizeText(queryClean);
            
            // Pre-fetch files if content search is needed
            if (searchInFiles) {
                await Promise.all(fileList.map(f => fetchFileContent(f)));
            }

            for (const filename of fileList) {
                const title = filename.replace(/\.lrc$/i, '');
                let content = "";
                if (searchInFiles) {
                    content = await fetchFileContent(filename);
                }

                let score = 999;

                // --- STANDARD MATCHING ---
                const titleRegexStart = new RegExp('^' + escapeRegExp(queryClean) + '\\b', 'i');
                const titleRegexWithin = new RegExp('\\b' + escapeRegExp(queryClean) + '\\b', 'i');
                const titleRegexEnd = new RegExp('\\b' + escapeRegExp(queryClean) + '$', 'i');
                
                if (titleRegexStart.test(title)) {
                    score = 1;
                } else if (titleRegexWithin.test(title)) {
                    score = 2;
                } else if (searchInFiles && new RegExp('\\b' + escapeRegExp(queryClean) + '\\b', 'i').test(content)) {
                    score = 2; // Same level as exact match within title
                } else if (titleRegexEnd.test(title)) {
                    score = 3;
                } else {
                    // Split words match in title
                    let allWordsFound = true;
                    for (const word of words) {
                        if (!new RegExp('\\b' + escapeRegExp(word) + '\\b', 'i').test(title)) {
                            allWordsFound = false;
                            break;
                        }
                    }
                    if (allWordsFound) score = 4;
                }

                // --- NORMALIZED MATCHING (Fallback) ---
                if (score === 999) {
                    const normTitle = normalizeText(title);
                    const normContent = normalizeText(content);
                    
                    if (normTitle.includes(normQuery)) {
                        score = 5;
                    } else if (searchInFiles && normContent.includes(normQuery)) {
                        score = 5;
                    } else {
                        // Normalized split words in title
                        let allNormWordsFound = true;
                        for (const word of words) {
                            const nWord = normalizeText(word);
                            if (nWord && !normTitle.includes(nWord)) {
                                allNormWordsFound = false;
                                break;
                            }
                        }
                        if (allNormWordsFound && words.length > 0) score = 6;
                    }
                }

                if (score < 999) {
                    // Fetch content now if not already fetched (for displaying preview)
                    if (!content) content = await fetchFileContent(filename);
                    results.push({ filename, title, raw: content, score });
                }
            }

            results.sort((a, b) => a.score - b.score);
            renderResults(results);
            loading.style.display = 'none';
        }

        function renderResults(results) {
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No results found.</p>';
                return;
            }

            results.forEach((res, index) => {
                const plainText = stripLrcTags(res.raw);
                const item = document.createElement('div');
                item.className = 'result-item';

                item.innerHTML = `
                    <div class="result-title">${res.title}</div>
                    <div class="tabs">
                        <button class="active" onclick="switchTab(${index}, 'plain')">Plain Text</button>
                        <button onclick="switchTab(${index}, 'synced')">Synced</button>
                    </div>
                    <div id="content-${index}" class="content-display"></div>
                    <div class="actions">
                        <button class="action-btn" id="expand-${index}" onclick="toggleExpand(${index})">Expand Full File</button>
                        <button class="action-btn" onclick="copyContent(${index})">Copy</button>
                    </div>
                `;
                resultsContainer.appendChild(item);

                // Store data in global object for easy access by UI handlers
                window[`resData_${index}`] = {
                    plain: plainText,
                    synced: res.raw,
                    currentTab: 'plain',
                    expanded: false
                };
                
                updateDisplay(index);
            });
        }

        window.switchTab = function(index, type) {
            window[`resData_${index}`].currentTab = type;
            const item = document.querySelectorAll('.result-item')[index];
            const btns = item.querySelectorAll('.tabs button');
            btns[0].classList.toggle('active', type === 'plain');
            btns[1].classList.toggle('active', type === 'synced');
            updateDisplay(index);
        }

        window.toggleExpand = function(index) {
            window[`resData_${index}`].expanded = !window[`resData_${index}`].expanded;
            const btn = document.getElementById(`expand-${index}`);
            btn.textContent = window[`resData_${index}`].expanded ? "Show Less" : "Expand Full File";
            updateDisplay(index);
        }

        window.copyContent = function(index) {
            const data = window[`resData_${index}`];
            const content = data.currentTab === 'plain' ? data.plain : data.synced;
            navigator.clipboard.writeText(content).then(() => {
                alert("Copied to clipboard!");
            });
        }

        function updateDisplay(index) {
            const data = window[`resData_${index}`];
            const contentDiv = document.getElementById(`content-${index}`);
            const fullContent = data.currentTab === 'plain' ? data.plain : data.synced;
            
            if (data.expanded) {
                contentDiv.textContent = fullContent || "No content available.";
            } else {
                const lines = fullContent.split('\n').slice(0, 5).join('\n');
                contentDiv.textContent = lines + (fullContent.split('\n').length > 5 ? '\n...' : '') || "No content available.";
            }
        }

        let debounceTimer;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                performSearch(e.target.value);
            }, 400); // 400ms delay to prevent excessive searching while typing
        });

        searchFilesCheck.addEventListener('change', () => {
            performSearch(searchInput.value);
        });

        // Init
        loadFileList();
    </script>
</body>
</html>
